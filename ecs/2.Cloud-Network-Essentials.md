# 클라우드 네트워크 완벽 가이드
## VPC, 로드 밸런서, Security Group 심화 이해

## 📌 개요

클라우드 환경에서 안전하고 효율적인 인프라를 구축하려면 네트워크 개념을 정확히 이해해야 한다. 이 문서는 AWS를 중심으로 VPC, 로드 밸런서, Security Group의 핵심 개념과 실무 적용 방법을 상세히 설명한다.

---

## 🌐 Part 1: VPC (Virtual Private Cloud)

### VPC란 무엇인가?

VPC는 클라우드 내에서 논리적으로 격리된 네트워크 공간이다. 물리적 데이터센터의 네트워크를 가상화한 것으로, 완전한 네트워크 제어권을 제공한다.

#### 핵심 개념 비유
```
물리 세계:          클라우드 세계:
건물 = 데이터센터    →  AWS 리전
층 = 서버랙         →  가용 영역(AZ)
사무실 = 서버       →  EC2 인스턴스
사내 네트워크       →  VPC
```

### VPC 구조와 구성 요소

#### 1. 계층 구조
```
AWS Account
└── Region (예: ap-northeast-2 서울)
    └── VPC (예: 10.0.0.0/16)
        ├── Availability Zone A
        │   ├── Public Subnet (10.0.1.0/24)
        │   └── Private Subnet (10.0.101.0/24)
        ├── Availability Zone B
        │   ├── Public Subnet (10.0.2.0/24)
        │   └── Private Subnet (10.0.102.0/24)
        └── Availability Zone C
            ├── Public Subnet (10.0.3.0/24)
            └── Private Subnet (10.0.103.0/24)
```

#### 2. CIDR 블록 이해
```bash
# VPC CIDR 예시
10.0.0.0/16 = 10.0.0.0 ~ 10.0.255.255 (65,536개 IP)

# 서브넷 분할
10.0.1.0/24 = 10.0.1.0 ~ 10.0.1.255 (256개 IP)
10.0.2.0/24 = 10.0.2.0 ~ 10.0.2.255 (256개 IP)

# 실제 사용 가능 IP (AWS 예약 IP 5개 제외)
# x.x.x.0: 네트워크 주소
# x.x.x.1: VPC 라우터
# x.x.x.2: DNS 서버
# x.x.x.3: 향후 사용 예약
# x.x.x.255: 브로드캐스트
실제 사용 가능: 251개
```

### 가용 영역(Availability Zone)과 서브넷

#### 가용 영역의 의미
- **물리적 분리**: 각 AZ는 독립된 전원, 냉각, 네트워크를 가진 데이터센터
- **지리적 분산**: 같은 리전 내에서도 수 km ~ 수십 km 떨어진 위치
- **고가용성**: 한 AZ 장애 시에도 다른 AZ에서 서비스 지속

#### 서브넷 설계 패턴

##### 1. 기본 3-Tier 아키텍처
```yaml
# Public Subnet: 인터넷 게이트웨이와 연결
- 용도: 로드 밸런서, NAT 게이트웨이, Bastion 호스트
- 라우팅: 0.0.0.0/0 → Internet Gateway

# Private Subnet: 인터넷 직접 접근 불가
- 용도: 애플리케이션 서버, 컨테이너
- 라우팅: 0.0.0.0/0 → NAT Gateway

# Database Subnet: 가장 제한적인 접근
- 용도: RDS, ElastiCache
- 라우팅: VPC 내부만 허용
```

##### 2. 실제 구현 예제
```bash
# AWS CLI로 VPC 생성
aws ec2 create-vpc \
    --cidr-block 10.0.0.0/16 \
    --tag-specifications 'ResourceType=vpc,Tags=[{Key=Name,Value=MyVPC}]'

# 서브넷 생성 (각 AZ별로)
aws ec2 create-subnet \
    --vpc-id vpc-xxxxx \
    --cidr-block 10.0.1.0/24 \
    --availability-zone ap-northeast-2a \
    --tag-specifications 'ResourceType=subnet,Tags=[{Key=Name,Value=Public-2a}]'
```

### VPC 고급 기능

#### 1. VPC Peering
```bash
# 다른 VPC와 연결
aws ec2 create-vpc-peering-connection \
    --vpc-id vpc-aaaaa \
    --peer-vpc-id vpc-bbbbb
    
# 특징:
# - 다른 계정, 다른 리전 VPC와도 연결 가능
# - 전이적 라우팅 불가 (A-B, B-C 연결이어도 A-C 직접 통신 불가)
# - 1:1 연결만 가능
```

#### 2. VPC Endpoint
```yaml
# S3 VPC Endpoint 설정 (인터넷 거치지 않고 S3 접근)
Type: AWS::EC2::VPCEndpoint
Properties:
  VpcId: !Ref VPC
  ServiceName: com.amazonaws.ap-northeast-2.s3
  RouteTableIds:
    - !Ref PrivateRouteTable
```

#### 3. Transit Gateway
```
중앙 허브 역할:
┌─────────┐     ┌─────────┐     ┌─────────┐
│  VPC 1  │────│ Transit  │────│  VPC 3  │
└─────────┘    │ Gateway  │    └─────────┘
               │          │
┌─────────┐    │          │    ┌─────────┐
│  VPC 2  │────│          │────│On-Premise│
└─────────┘    └──────────┘    └─────────┘
```

---

## ⚖️ Part 2: 로드 밸런서 심화 이해

### 로드 밸런서 종류와 선택

#### 1. Application Load Balancer (ALB)
```yaml
특징:
- Layer 7 (HTTP/HTTPS)
- 경로 기반 라우팅
- 호스트 기반 라우팅
- WebSocket 지원
- HTTP/2 지원

사용 사례:
- 마이크로서비스
- 컨테이너 기반 애플리케이션
- 웹 애플리케이션
```

#### 2. Network Load Balancer (NLB)
```yaml
특징:
- Layer 4 (TCP/UDP)
- 초고속 성능 (수백만 RPS)
- 고정 IP 지원
- 소스 IP 보존

사용 사례:
- 게임 서버
- IoT 애플리케이션
- 금융 거래 시스템
```

#### 3. Classic Load Balancer (CLB)
```yaml
특징:
- 레거시 (신규 사용 비추천)
- Layer 4/7 혼합
- EC2-Classic 지원

마이그레이션 권장:
CLB → ALB or NLB
```

### 리스너 규칙 (Listener Rules) 상세

#### 규칙 우선순위와 처리
```json
{
  "Rules": [
    {
      "Priority": 1,
      "Conditions": [
        {
          "Field": "host-header",
          "Values": ["api.example.com"]
        }
      ],
      "Actions": [
        {
          "Type": "forward",
          "TargetGroupArn": "arn:aws:elasticloadbalancing:..."
        }
      ]
    },
    {
      "Priority": 2,
      "Conditions": [
        {
          "Field": "path-pattern",
          "Values": ["/admin/*"]
        }
      ],
      "Actions": [
        {
          "Type": "authenticate-cognito",
          "AuthenticateCognitoConfig": {
            "UserPoolArn": "arn:aws:cognito-idp:..."
          }
        },
        {
          "Type": "forward",
          "TargetGroupArn": "arn:aws:elasticloadbalancing:..."
        }
      ]
    }
  ]
}
```

#### 고급 라우팅 패턴

##### 1. 가중치 기반 라우팅
```yaml
# Blue-Green 배포나 A/B 테스트에 활용
Actions:
  - Type: forward
    ForwardConfig:
      TargetGroups:
        - TargetGroupArn: !Ref BlueTargetGroup
          Weight: 80
        - TargetGroupArn: !Ref GreenTargetGroup
          Weight: 20
```

##### 2. 조건부 라우팅
```python
# 다양한 조건 조합
conditions = [
    {
        "Field": "http-request-method",
        "HttpRequestMethodConfig": {
            "Values": ["POST", "PUT"]
        }
    },
    {
        "Field": "http-header",
        "HttpHeaderConfig": {
            "HeaderName": "X-Custom-Header",
            "Values": ["value1", "value2"]
        }
    },
    {
        "Field": "source-ip",
        "SourceIpConfig": {
            "Values": ["192.168.1.0/24"]
        }
    }
]
```

### 타겟 그룹 (Target Groups) 관리

#### 헬스 체크 설정
```yaml
HealthCheck:
  Protocol: HTTP
  Path: /health
  Port: traffic-port
  HealthyThresholdCount: 2      # 연속 성공 횟수
  UnhealthyThresholdCount: 3    # 연속 실패 횟수
  TimeoutSeconds: 5              # 응답 대기 시간
  IntervalSeconds: 30            # 체크 간격
  Matcher:
    HttpCode: 200-299           # 성공으로 간주할 HTTP 코드
```

#### 타겟 종류
```yaml
# 1. Instance (EC2)
Targets:
  - Id: i-1234567890abcdef0
    Port: 80

# 2. IP (Fargate, 온프레미스)
Targets:
  - Id: 10.0.1.100
    Port: 8080
    
# 3. Lambda
Targets:
  - Id: arn:aws:lambda:region:account:function:my-function
```

#### Connection Draining (등록 해제 지연)
```bash
# 타겟 제거 시 기존 연결 처리
aws elbv2 modify-target-group-attributes \
    --target-group-arn arn:aws:elasticloadbalancing:... \
    --attributes Key=deregistration_delay.timeout_seconds,Value=30
```

### 로드 밸런서 성능 최적화

#### 1. Cross-Zone Load Balancing
```
활성화 전:
AZ-A: LB → [Instance1(50%), Instance2(50%)]
AZ-B: LB → [Instance3(100%)]
결과: 불균등 분산

활성화 후:
모든 인스턴스가 33.33%씩 균등 분산
```

#### 2. Sticky Sessions
```yaml
# 세션 유지 설정
TargetGroupAttributes:
  - Key: stickiness.enabled
    Value: true
  - Key: stickiness.type
    Value: app_cookie
  - Key: stickiness.app_cookie.cookie_name
    Value: SESSIONID
  - Key: stickiness.app_cookie.duration_seconds
    Value: 86400
```

---

## 🔒 Part 3: Security Group 완벽 가이드

### Security Group 핵심 이해

#### 기본 특성
```yaml
특징:
- Stateful: 나가는 트래픽에 대한 응답은 자동 허용
- 기본 거부: 명시적 허용만 가능 (거부 규칙 없음)
- 인스턴스 레벨: 각 ENI(Elastic Network Interface)에 적용
- 다중 적용: 하나의 인스턴스에 최대 5개 SG 적용 가능
```

### 인바운드/아웃바운드 규칙 상세

#### 1. 규칙 구조
```json
{
  "IpProtocol": "tcp",
  "FromPort": 443,
  "ToPort": 443,
  "IpRanges": [
    {
      "CidrIp": "0.0.0.0/0",
      "Description": "HTTPS from anywhere"
    }
  ],
  "Ipv6Ranges": [
    {
      "CidrIpv6": "::/0",
      "Description": "HTTPS from anywhere IPv6"
    }
  ],
  "UserIdGroupPairs": [
    {
      "GroupId": "sg-123456",
      "Description": "From Load Balancer SG"
    }
  ]
}
```

#### 2. 프로토콜별 설정 예시

##### HTTP/HTTPS 웹 서버
```bash
# 인바운드
aws ec2 authorize-security-group-ingress \
    --group-id sg-xxxxx \
    --protocol tcp \
    --port 443 \
    --cidr 0.0.0.0/0

# 아웃바운드 (기본적으로 모두 허용)
# DNS, 시간 동기화, 패키지 업데이트 등을 위해
```

##### 데이터베이스 서버
```bash
# PostgreSQL - 앱 서버 SG에서만 접근
aws ec2 authorize-security-group-ingress \
    --group-id sg-db-xxxxx \
    --protocol tcp \
    --port 5432 \
    --source-group sg-app-xxxxx
```

##### SSH/RDP 관리 접근
```bash
# Bastion 호스트나 특정 IP에서만
aws ec2 authorize-security-group-ingress \
    --group-id sg-xxxxx \
    --protocol tcp \
    --port 22 \
    --cidr 203.0.113.0/32  # 특정 IP만
```

### 보안 그룹 설계 패턴

#### 1. 계층별 보안 그룹 구성
```
┌─────────────────────────────────────┐
│         인터넷                       │
└─────────────┬───────────────────────┘
              │
    ┌─────────▼──────────┐
    │   ALB SG           │
    │   In: 0.0.0.0/0:443│
    │   Out: App-SG:8080 │
    └─────────┬──────────┘
              │
    ┌─────────▼──────────┐
    │   App SG           │
    │   In: ALB-SG:8080  │
    │   Out: DB-SG:5432  │
    └─────────┬──────────┘
              │
    ┌─────────▼──────────┐
    │   DB SG            │
    │   In: App-SG:5432  │
    │   Out: None        │
    └────────────────────┘
```

#### 2. 마이크로서비스 보안 그룹
```yaml
# 서비스 간 통신 제어
UserService-SG:
  Inbound:
    - From: Gateway-SG, Port: 8080
    
OrderService-SG:
  Inbound:
    - From: Gateway-SG, Port: 8081
    - From: UserService-SG, Port: 8081
    
PaymentService-SG:
  Inbound:
    - From: OrderService-SG, Port: 8082
```

### 디폴트 보안 그룹의 함정과 대응

#### 문제 상황
```bash
# 잘못된 설정 (보안 위험!)
aws ec2 authorize-security-group-ingress \
    --group-id sg-default \
    --protocol -1 \
    --port -1 \
    --cidr 0.0.0.0/0
    
# 결과: 모든 포트가 인터넷에 노출
```

#### 올바른 접근
```bash
# 1. 역할별 보안 그룹 생성
aws ec2 create-security-group \
    --group-name web-servers \
    --description "Security group for web servers"

# 2. 최소 권한 원칙 적용
aws ec2 authorize-security-group-ingress \
    --group-id sg-web \
    --protocol tcp \
    --port 443 \
    --cidr 0.0.0.0/0

# 3. 디폴트 SG는 내부 통신용으로만 사용
```

### 실전 보안 체크리스트

#### 1. 정기 감사 스크립트
```python
import boto3

def audit_security_groups():
    ec2 = boto3.client('ec2')
    
    # 위험한 규칙 찾기
    dangerous_rules = []
    
    response = ec2.describe_security_groups()
    
    for sg in response['SecurityGroups']:
        for rule in sg['IpPermissions']:
            # 0.0.0.0/0에서 SSH/RDP 허용 체크
            if rule.get('FromPort') in [22, 3389]:
                for ip_range in rule.get('IpRanges', []):
                    if ip_range.get('CidrIp') == '0.0.0.0/0':
                        dangerous_rules.append({
                            'GroupId': sg['GroupId'],
                            'Port': rule['FromPort'],
                            'Risk': 'HIGH - Management port open to internet'
                        })
    
    return dangerous_rules
```

#### 2. 네트워크 격리 전략
```yaml
# Production 환경
Production-VPC:
  CIDR: 10.0.0.0/16
  SecurityGroups:
    - Prod-Web-SG
    - Prod-App-SG
    - Prod-DB-SG
  NetworkACLs: Restrictive

# Development 환경 (완전 분리)
Development-VPC:
  CIDR: 10.1.0.0/16
  SecurityGroups:
    - Dev-Web-SG
    - Dev-App-SG
    - Dev-DB-SG
  NetworkACLs: Permissive

# VPC Peering으로 필요시만 연결
```

---

## 🚀 실전 적용 시나리오

### 시나리오 1: ECS Fargate 배포
```yaml
# 1. VPC 구성
VPC: 10.0.0.0/16
├── Public Subnet (ALB): 10.0.1.0/24, 10.0.2.0/24
└── Private Subnet (ECS): 10.0.101.0/24, 10.0.102.0/24

# 2. Security Group 구성
ALB-SG:
  Inbound: 0.0.0.0/0:443
  Outbound: ECS-SG:8080

ECS-SG:
  Inbound: ALB-SG:8080
  Outbound: 0.0.0.0/0:443 (외부 API 호출용)

# 3. 로드 밸런서 설정
ALB:
  Listener: HTTPS:443
  Target Group: ECS Tasks (IP targets)
  Health Check: /health
```

### 시나리오 2: 멀티 티어 웹 애플리케이션
```bash
# Terraform으로 구성
resource "aws_vpc" "main" {
  cidr_block = "10.0.0.0/16"
  
  enable_dns_hostnames = true
  enable_dns_support = true
}

resource "aws_subnet" "public" {
  count = 2
  vpc_id = aws_vpc.main.id
  cidr_block = "10.0.${count.index + 1}.0/24"
  availability_zone = data.aws_availability_zones.available.names[count.index]
  map_public_ip_on_launch = true
}

resource "aws_security_group" "alb" {
  name = "alb-security-group"
  vpc_id = aws_vpc.main.id
  
  ingress {
    from_port = 443
    to_port = 443
    protocol = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
  
  egress {
    from_port = 0
    to_port = 0
    protocol = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}
```

### 시나리오 3: 제로 트러스트 네트워크
```yaml
# 모든 통신 암호화 및 인증
Service Mesh (Istio):
  mTLS: enabled
  Authorization Policies: strict
  
Network Policies:
  Default: Deny All
  Explicit Allow: Per Service
  
WAF Rules:
  SQL Injection: Block
  XSS: Block
  Rate Limiting: 1000 req/min
```

---

## 📊 모니터링과 트러블슈팅

### VPC Flow Logs 분석
```python
# Flow Logs 파싱 예제
import pandas as pd

def analyze_flow_logs(log_file):
    # Flow Log 포맷
    columns = ['version', 'account', 'interface', 'srcaddr', 
               'dstaddr', 'srcport', 'dstport', 'protocol', 
               'packets', 'bytes', 'start', 'end', 'action', 'log_status']
    
    df = pd.read_csv(log_file, sep=' ', names=columns)
    
    # 거부된 트래픽 분석
    rejected = df[df['action'] == 'REJECT']
    
    # Top 10 차단된 소스 IP
    top_blocked = rejected['srcaddr'].value_counts().head(10)
    
    return {
        'total_rejected': len(rejected),
        'top_blocked_ips': top_blocked.to_dict()
    }
```

### 로드 밸런서 메트릭
```bash
# CloudWatch 메트릭 확인
aws cloudwatch get-metric-statistics \
    --namespace AWS/ApplicationELB \
    --metric-name TargetResponseTime \
    --dimensions Name=LoadBalancer,Value=app/my-alb/xxxxx \
    --start-time 2024-01-01T00:00:00Z \
    --end-time 2024-01-01T23:59:59Z \
    --period 300 \
    --statistics Average
```

### Security Group 변경 추적
```python
# CloudTrail 이벤트 모니터링
import boto3

def track_sg_changes():
    cloudtrail = boto3.client('cloudtrail')
    
    response = cloudtrail.lookup_events(
        LookupAttributes=[
            {
                'AttributeKey': 'EventName',
                'AttributeValue': 'AuthorizeSecurityGroupIngress'
            }
        ],
        MaxResults=50
    )
    
    for event in response['Events']:
        print(f"Time: {event['EventTime']}")
        print(f"User: {event['Username']}")
        print(f"SG: {event['Resources'][0]['ResourceName']}")
```

---

## 🎯 베스트 프랙티스 총정리

### VPC 설계 원칙
1. **IP 대역 계획**: 충분한 여유를 두고 CIDR 블록 할당
2. **서브넷 분리**: Public/Private/Database 레이어 명확히 구분
3. **멀티 AZ**: 최소 2개 이상의 AZ 사용
4. **VPC Endpoint**: AWS 서비스 접근 시 인터넷 경유 최소화

### 로드 밸런서 운영
1. **헬스체크 튜닝**: 서비스 특성에 맞게 조정
2. **Connection Draining**: 30-60초 설정으로 graceful shutdown
3. **Access Logs**: S3에 저장하여 분석
4. **SSL/TLS**: 최신 정책 사용, SSL Labs A+ 등급 유지

### Security Group 관리
1. **최소 권한 원칙**: 필요한 포트와 소스만 허용
2. **설명 필수**: 모든 규칙에 명확한 설명 추가
3. **정기 감사**: 자동화된 스크립트로 위험 규칙 탐지
4. **변경 관리**: Terraform/CloudFormation으로 코드화

---

## 💡 실무 팁

### 비용 최적화
```yaml
# NAT Gateway 비용 절감
단일 NAT: 
  - 개발 환경
  - 비용: $45/월

다중 NAT (HA):
  - 프로덕션 환경
  - 비용: $135/월 (3 AZ)

# VPC Endpoint로 데이터 전송 비용 절감
S3 Transfer:
  - Internet Gateway: $0.09/GB
  - VPC Endpoint: $0.01/GB
```

### 성능 최적화
```yaml
# Network 성능 향상
Enhanced Networking: 
  - SR-IOV 활성화
  - 최대 100 Gbps

Placement Groups:
  - Cluster: 낮은 지연 시간
  - Spread: 고가용성
  - Partition: 대규모 분산 워크로드
```

### 보안 강화
```bash
# AWS Systems Manager Session Manager
# Bastion 호스트 없이 안전한 접근
aws ssm start-session --target i-1234567890abcdef0

# VPC Endpoint for SSM 설정 필요
- com.amazonaws.region.ssm
- com.amazonaws.region.ec2messages
- com.amazonaws.region.ssmmessages
```

---

## 🎬 결론

클라우드 네트워크의 세 가지 핵심 요소인 VPC, 로드 밸런서, Security Group을 제대로 이해하고 구성하는 것은 안전하고 효율적인 인프라의 기초다.

### 핵심 포인트
1. **VPC는 격리의 기본**: 네트워크 레벨에서 첫 번째 방어선
2. **로드 밸런서는 가용성의 핵심**: 트래픽 분산과 헬스체크로 안정성 확보
3. **Security Group은 최후의 방어선**: 인스턴스 레벨에서 정밀한 제어

### 다음 단계
- 실제 환경에 적용하며 경험 축적
- 자동화 도구 (Terraform, CDK) 활용
- 모니터링과 알림 체계 구축
- 정기적인 보안 감사 실시

기초를 탄탄히 다진 후, 점진적으로 고급 기능을 도입하는 것이 안정적인 클라우드 인프라 구축의 지름길이다.