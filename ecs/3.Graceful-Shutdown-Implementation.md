# Graceful Shutdown ì™„ë²½ êµ¬í˜„ ê°€ì´ë“œ
## Docker ì»¨í…Œì´ë„ˆ í™˜ê²½ì—ì„œ ì•ˆì „í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ

## ğŸ“Œ ê°œìš”

Graceful Shutdownì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¢…ë£Œë  ë•Œ ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì„ ì•ˆì „í•˜ê²Œ ì™„ë£Œí•˜ê³ , ìƒˆë¡œìš´ ìš”ì²­ì„ ë°›ì§€ ì•Šë„ë¡ í•˜ëŠ” ë§¤ìš° ì¤‘ìš”í•œ íŒ¨í„´ì´ë‹¤. íŠ¹íˆ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œëŠ” ë°°í¬ ì‹œ ìˆœê°„ì ì¸ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ëŠ” í•µì‹¬ ê¸°ëŠ¥ì´ë‹¤.

---

## ğŸ¯ Part 1: Graceful Shutdown ê°œë…ê³¼ í•„ìš”ì„±

### Docker ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ë©”ì»¤ë‹ˆì¦˜

#### 1. ì‹ í˜¸(Signal) ê¸°ë°˜ ì¢…ë£Œ
```bash
# SIGTERM ì „ì†¡ í›„ 10ì´ˆ ëŒ€ê¸°, ì´í›„ SIGKILL
docker stop <container>

# ì¦‰ì‹œ ê°•ì œ ì¢…ë£Œ
docker kill <container>
```

#### 2. í”„ë¡œì„¸ìŠ¤ ì‹ í˜¸ ì²˜ë¦¬ ê³¼ì •
```
1. docker stop ì‹¤í–‰
2. Dockerê°€ ì»¨í…Œì´ë„ˆì˜ ë©”ì¸ í”„ë¡œì„¸ìŠ¤(PID 1)ì— SIGTERM ì „ì†¡
3. í”„ë¡œì„¸ìŠ¤ê°€ ì‹ í˜¸ë¥¼ ë°›ì•„ graceful shutdown ì‹¤í–‰
4. 10ì´ˆ í›„ì—ë„ ì¢…ë£Œë˜ì§€ ì•Šìœ¼ë©´ SIGKILLë¡œ ê°•ì œ ì¢…ë£Œ
```

### Graceful Shutdownì´ ì—†ì„ ë•Œì˜ ë¬¸ì œì 

#### 1. ìš”ì²­ ì²˜ë¦¬ ì¤‘ë‹¨
```javascript
// ë¬¸ì œ ìƒí™©
app.get('/long-process', async (req, res) => {
    // ê¸´ ì‘ì—… ì²˜ë¦¬ (ì˜ˆ: íŒŒì¼ ì—…ë¡œë“œ, ë°ì´í„° ì²˜ë¦¬)
    const result = await processLargeFile(req.file);
    res.json({ result });
});

// ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ì‹œ:
// - ì²˜ë¦¬ ì¤‘ì¸ íŒŒì¼ ì—…ë¡œë“œ ì¤‘ë‹¨
// - í´ë¼ì´ì–¸íŠ¸ì—ê²Œ 500 ì—ëŸ¬ ë°˜í™˜
// - ë°ì´í„° ì¼ê´€ì„± ë¬¸ì œ ë°œìƒ
```

#### 2. ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ ë¬¸ì œ
```javascript
// ê°‘ì‘ìŠ¤ëŸ¬ìš´ ì¢…ë£Œë¡œ ì¸í•œ ë¬¸ì œ
const db = require('./database');

// íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ì¤‘ ê°•ì œ ì¢…ë£Œ
await db.beginTransaction();
await db.query('UPDATE accounts SET balance = ?', [newBalance]);
// ì—¬ê¸°ì„œ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ â†’ ë¡¤ë°±ë˜ì§€ ì•ŠìŒ
await db.query('INSERT INTO transactions ...'); // ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
await db.commit(); // ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
```

#### 3. ì‹¤ì œ ì„œë¹„ìŠ¤ ì˜í–¥
```
ë°°í¬ ì‹œë‚˜ë¦¬ì˜¤:
1. ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹œì‘
2. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ (docker stop)
3. ë¡œë“œ ë°¸ëŸ°ì„œê°€ íŠ¸ë˜í”½ì„ ìƒˆ ì»¨í…Œì´ë„ˆë¡œ ì „í™˜

ë¬¸ì œ:
- 2-3ë²ˆ ì‚¬ì´ì˜ í‹ˆìƒˆì— ë“¤ì–´ì˜¨ ìš”ì²­ ì†ì‹¤
- ì‚¬ìš©ìì—ê²Œ "ì„œë¹„ìŠ¤ ì ê²€ ì¤‘" ë©”ì‹œì§€
- ì—…ë¬´ ì‹œê°„ ë°°í¬ ë¶ˆê°€ëŠ¥
```

---

## ğŸ”§ Part 2: Node.js/Express í™˜ê²½ êµ¬í˜„

### ê¸°ë³¸ Graceful Shutdown êµ¬í˜„

#### 1. ì‹ í˜¸ ì²˜ë¦¬ê¸° ì„¤ì •
```javascript
// server.js
const express = require('express');
const app = express();
const port = process.env.PORT || 3000;

// Express ì„œë²„ ì‹œì‘
const server = app.listen(port, () => {
    console.log(`Server running on port ${port}`);
});

// Graceful Shutdown êµ¬í˜„
const gracefulShutdown = (signal) => {
    console.log(`Received ${signal}, starting graceful shutdown...`);
    
    // 1. ìƒˆë¡œìš´ ì—°ê²° ë°›ì§€ ì•Šê¸°
    server.close((err) => {
        if (err) {
            console.error('Error during server close:', err);
            process.exit(1);
        }
        
        console.log('HTTP server closed');
        
        // 2. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë¦¬
        // 3. ê¸°íƒ€ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
        // 4. í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
        console.log('Graceful shutdown completed');
        process.exit(0);
    });
};

// ì‹ í˜¸ ì²˜ë¦¬ê¸° ë“±ë¡
process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));

// ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì˜ˆì™¸ ì²˜ë¦¬
process.on('uncaughtException', (err) => {
    console.error('Uncaught Exception:', err);
    gracefulShutdown('uncaughtException');
});

process.on('unhandledRejection', (reason, promise) => {
    console.error('Unhandled Rejection at:', promise, 'reason:', reason);
    gracefulShutdown('unhandledRejection');
});
```

#### 2. í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
```javascript
// ì„œë²„ ìƒíƒœ ê´€ë¦¬
let isShuttingDown = false;

// í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸
app.get('/health', (req, res) => {
    if (isShuttingDown) {
        res.status(503).json({ 
            status: 'shutting down',
            message: 'Server is shutting down'
        });
    } else {
        res.status(200).json({ 
            status: 'healthy',
            uptime: process.uptime(),
            timestamp: new Date().toISOString()
        });
    }
});

// Graceful Shutdown ìˆ˜ì •
const gracefulShutdown = (signal) => {
    console.log(`Received ${signal}, starting graceful shutdown...`);
    
    // ìƒíƒœ ë³€ê²½ (í—¬ìŠ¤ì²´í¬ê°€ ì‹¤íŒ¨í•˜ë„ë¡)
    isShuttingDown = true;
    
    // ë¡œë“œ ë°¸ëŸ°ì„œê°€ íŠ¸ë˜í”½ì„ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ë³´ë‚´ë„ë¡ ì ì‹œ ëŒ€ê¸°
    setTimeout(() => {
        server.close((err) => {
            if (err) {
                console.error('Error during server close:', err);
                process.exit(1);
            }
            
            console.log('HTTP server closed');
            process.exit(0);
        });
    }, 2000); // 2ì´ˆ ëŒ€ê¸°
};
```

### npm í”„ë¡œì„¸ìŠ¤ ë¬¸ì œ í•´ê²°

#### 1. ë¬¸ì œ ìƒí™© ë¶„ì„
```dockerfile
# ë¬¸ì œê°€ ìˆëŠ” Dockerfile
FROM node:16-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .

# npmì´ ë©”ì¸ í”„ë¡œì„¸ìŠ¤ê°€ ë˜ì–´ ì‹ í˜¸ë¥¼ ê°€ë¡œì±”
CMD ["npm", "start"]
```

```bash
# í”„ë¡œì„¸ìŠ¤ íŠ¸ë¦¬ í™•ì¸
docker exec <container> ps aux
# PID 1: npm
# PID 15: node server.js

# SIGTERMì´ npmì—ê²Œë§Œ ì „ë‹¬ë˜ê³ , node í”„ë¡œì„¸ìŠ¤ëŠ” ë°›ì§€ ëª»í•¨
```

#### 2. í•´ê²° ë°©ë²•ë“¤

##### ë°©ë²• 1: ì§ì ‘ node ì‹¤í–‰
```dockerfile
# ê¶Œì¥ ë°©ë²•
FROM node:16-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .

# npm ëŒ€ì‹  ì§ì ‘ node ì‹¤í–‰
CMD ["node", "server.js"]
```

##### ë°©ë²• 2: npm ì‹ í˜¸ ì „ë‹¬ ì„¤ì •
```json
// package.json
{
  "scripts": {
    "start": "node server.js"
  }
}
```

```dockerfile
# execë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹ í˜¸ ì „ë‹¬
CMD ["sh", "-c", "exec npm start"]
```

##### ë°©ë²• 3: init ì‹œìŠ¤í…œ ì‚¬ìš©
```dockerfile
# tini ì‚¬ìš© (ì‹ í˜¸ ì²˜ë¦¬ ì „ë¬¸ init ì‹œìŠ¤í…œ)
FROM node:16-alpine
RUN apk add --no-cache tini
ENTRYPOINT ["/sbin/tini", "--"]
CMD ["node", "server.js"]
```

### ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë¦¬

#### 1. MongoDB ì—°ê²° ì •ë¦¬
```javascript
const mongoose = require('mongoose');

// ì—°ê²° ì„¤ì •
mongoose.connect('mongodb://localhost:27017/myapp', {
    useNewUrlParser: true,
    useUnifiedTopology: true,
});

const gracefulShutdown = async (signal) => {
    console.log(`Received ${signal}, starting graceful shutdown...`);
    
    server.close(async (err) => {
        if (err) {
            console.error('Error during server close:', err);
            process.exit(1);
        }
        
        try {
            // MongoDB ì—°ê²° ë‹«ê¸°
            await mongoose.connection.close();
            console.log('MongoDB connection closed');
            
            console.log('Graceful shutdown completed');
            process.exit(0);
        } catch (error) {
            console.error('Error during MongoDB close:', error);
            process.exit(1);
        }
    });
};
```

#### 2. PostgreSQL ì—°ê²° ì •ë¦¬
```javascript
const { Pool } = require('pg');

const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    max: 20,
    idleTimeoutMillis: 30000,
    connectionTimeoutMillis: 2000,
});

const gracefulShutdown = (signal) => {
    console.log(`Received ${signal}, starting graceful shutdown...`);
    
    server.close(async (err) => {
        if (err) {
            console.error('Error during server close:', err);
            process.exit(1);
        }
        
        try {
            // PostgreSQL ì»¤ë„¥ì…˜ í’€ ë‹«ê¸°
            await pool.end();
            console.log('PostgreSQL connection pool closed');
            
            console.log('Graceful shutdown completed');
            process.exit(0);
        } catch (error) {
            console.error('Error during pool close:', error);
            process.exit(1);
        }
    });
};
```

#### 3. Redis ì—°ê²° ì •ë¦¬
```javascript
const redis = require('redis');
const client = redis.createClient({
    host: process.env.REDIS_HOST || 'localhost',
    port: process.env.REDIS_PORT || 6379,
});

const gracefulShutdown = (signal) => {
    console.log(`Received ${signal}, starting graceful shutdown...`);
    
    server.close((err) => {
        if (err) {
            console.error('Error during server close:', err);
            process.exit(1);
        }
        
        // Redis ì—°ê²° ë‹«ê¸°
        client.quit((err) => {
            if (err) {
                console.error('Error during Redis close:', err);
            } else {
                console.log('Redis connection closed');
            }
            
            console.log('Graceful shutdown completed');
            process.exit(err ? 1 : 0);
        });
    });
};
```

---

## ğŸŒ Part 3: ë‹¤ì–‘í•œ í™˜ê²½ë³„ êµ¬í˜„

### Express.js with TypeScript
```typescript
// server.ts
import express from 'express';
import { createConnection, Connection } from 'typeorm';
import { Server } from 'http';

interface ShutdownManager {
    server: Server;
    database: Connection;
    isShuttingDown: boolean;
}

class GracefulShutdown {
    private shutdownManager: ShutdownManager;
    private shutdownTimeout: number;

    constructor(server: Server, database: Connection, timeout: number = 30000) {
        this.shutdownManager = {
            server,
            database,
            isShuttingDown: false
        };
        this.shutdownTimeout = timeout;
        
        this.setupSignalHandlers();
    }

    private setupSignalHandlers(): void {
        const signals: NodeJS.Signals[] = ['SIGTERM', 'SIGINT'];
        
        signals.forEach(signal => {
            process.on(signal, () => this.shutdown(signal));
        });
    }

    private async shutdown(signal: string): Promise<void> {
        if (this.shutdownManager.isShuttingDown) {
            console.log('Shutdown already in progress...');
            return;
        }

        console.log(`Received ${signal}, starting graceful shutdown...`);
        this.shutdownManager.isShuttingDown = true;

        // íƒ€ì„ì•„ì›ƒ ì„¤ì •
        const shutdownTimer = setTimeout(() => {
            console.error('Graceful shutdown timeout, forcing exit');
            process.exit(1);
        }, this.shutdownTimeout);

        try {
            // HTTP ì„œë²„ ì¢…ë£Œ
            await this.closeServer();
            
            // ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¢…ë£Œ
            await this.closeDatabase();
            
            console.log('Graceful shutdown completed');
            clearTimeout(shutdownTimer);
            process.exit(0);
        } catch (error) {
            console.error('Error during graceful shutdown:', error);
            clearTimeout(shutdownTimer);
            process.exit(1);
        }
    }

    private closeServer(): Promise<void> {
        return new Promise((resolve, reject) => {
            this.shutdownManager.server.close((err) => {
                if (err) {
                    reject(err);
                } else {
                    console.log('HTTP server closed');
                    resolve();
                }
            });
        });
    }

    private async closeDatabase(): Promise<void> {
        if (this.shutdownManager.database.isConnected) {
            await this.shutdownManager.database.close();
            console.log('Database connection closed');
        }
    }

    public isShuttingDown(): boolean {
        return this.shutdownManager.isShuttingDown;
    }
}

// ì‚¬ìš© ì˜ˆì œ
const app = express();
const port = process.env.PORT || 3000;

// í—¬ìŠ¤ì²´í¬ (Graceful Shutdown ì¸ìŠ¤í„´ìŠ¤ê°€ í•„ìš”)
let gracefulShutdown: GracefulShutdown;

app.get('/health', (req, res) => {
    if (gracefulShutdown && gracefulShutdown.isShuttingDown()) {
        res.status(503).json({ status: 'shutting down' });
    } else {
        res.status(200).json({ status: 'healthy' });
    }
});

// ì„œë²„ ì‹œì‘
const server = app.listen(port, async () => {
    console.log(`Server running on port ${port}`);
    
    // ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
    const database = await createConnection();
    
    // Graceful Shutdown ì„¤ì •
    gracefulShutdown = new GracefulShutdown(server, database);
});
```

### Fastify í”„ë ˆì„ì›Œí¬
```javascript
// fastify-server.js
const fastify = require('fastify')({ logger: true });

// í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
fastify.register(require('fastify-postgres'), {
    connectionString: process.env.DATABASE_URL
});

// í—¬ìŠ¤ì²´í¬ ë¼ìš°íŠ¸
fastify.get('/health', async (request, reply) => {
    if (fastify.isShuttingDown) {
        reply.code(503).send({ status: 'shutting down' });
    } else {
        reply.send({ status: 'healthy' });
    }
});

// Graceful Shutdown
const gracefulShutdown = async (signal) => {
    fastify.log.info(`Received ${signal}, starting graceful shutdown...`);
    
    try {
        // FastifyëŠ” close() ë©”ì„œë“œê°€ ëª¨ë“  í”ŒëŸ¬ê·¸ì¸ì„ ì •ë¦¬í•¨
        await fastify.close();
        fastify.log.info('Graceful shutdown completed');
        process.exit(0);
    } catch (err) {
        fastify.log.error('Error during graceful shutdown:', err);
        process.exit(1);
    }
};

// ì‹ í˜¸ ì²˜ë¦¬ê¸°
process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));

// ì„œë²„ ì‹œì‘
const start = async () => {
    try {
        await fastify.listen(3000, '0.0.0.0');
        fastify.log.info('Server is running on port 3000');
    } catch (err) {
        fastify.log.error(err);
        process.exit(1);
    }
};

start();
```

### Koa.js í”„ë ˆì„ì›Œí¬
```javascript
// koa-server.js
const Koa = require('koa');
const Router = require('koa-router');

const app = new Koa();
const router = new Router();

let isShuttingDown = false;

// ë¯¸ë“¤ì›¨ì–´: Shutdown ì¤‘ì—ëŠ” 503 ë°˜í™˜
app.use(async (ctx, next) => {
    if (isShuttingDown && ctx.path !== '/health') {
        ctx.status = 503;
        ctx.body = { error: 'Server is shutting down' };
        return;
    }
    await next();
});

// í—¬ìŠ¤ì²´í¬
router.get('/health', (ctx) => {
    if (isShuttingDown) {
        ctx.status = 503;
        ctx.body = { status: 'shutting down' };
    } else {
        ctx.status = 200;
        ctx.body = { status: 'healthy' };
    }
});

app.use(router.routes());

// ì„œë²„ ì‹œì‘
const server = app.listen(3000, () => {
    console.log('Koa server running on port 3000');
});

// Graceful Shutdown
const gracefulShutdown = (signal) => {
    console.log(`Received ${signal}, starting graceful shutdown...`);
    isShuttingDown = true;
    
    setTimeout(() => {
        server.close((err) => {
            if (err) {
                console.error('Error during server close:', err);
                process.exit(1);
            }
            
            console.log('Koa server closed');
            process.exit(0);
        });
    }, 2000);
};

process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));
```

---

## ğŸ³ Part 4: Docker ìµœì í™”

### Dockerfile ìµœì í™”

#### 1. ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ + Graceful Shutdown
```dockerfile
# Build stage
FROM node:16-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# Production stage
FROM node:16-alpine
WORKDIR /app

# ë³´ì•ˆ ê°•í™”: non-root ì‚¬ìš©ì ìƒì„±
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001

# ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ë³µì‚¬
COPY --from=builder /app/node_modules ./node_modules
COPY --chown=nodejs:nodejs . .

# ì‚¬ìš©ì ë³€ê²½
USER nodejs

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 3000

# Graceful Shutdownì„ ìœ„í•œ ì˜¬ë°”ë¥¸ ì‹œì‘ ëª…ë ¹
CMD ["node", "server.js"]
```

#### 2. ì‹ í˜¸ ì²˜ë¦¬ ìµœì í™”
```dockerfile
# tini ì‚¬ìš© (ë” ë‚˜ì€ ì‹ í˜¸ ì²˜ë¦¬)
FROM node:16-alpine
RUN apk add --no-cache tini

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .

# tinië¥¼ init í”„ë¡œì„¸ìŠ¤ë¡œ ì‚¬ìš©
ENTRYPOINT ["/sbin/tini", "--"]
CMD ["node", "server.js"]
```

#### 3. .dockerignore ìµœì í™”
```dockerignore
node_modules
npm-debug.log
.nyc_output
coverage
.coverage
.env
.git
.gitignore
README.md
.eslintrc
.prettierrc
Dockerfile
.dockerignore
docker-compose.yml
```

### Docker Compose ì„¤ì •
```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgres://user:pass@db:5432/mydb
    depends_on:
      - db
    restart: unless-stopped
    # Graceful Shutdown ì„¤ì •
    stop_grace_period: 30s
    stop_signal: SIGTERM
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  db:
    image: postgres:13-alpine
    environment:
      - POSTGRES_DB=mydb
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - db_data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  db_data:
```

---

## ğŸš€ Part 5: í”„ë¡œë•ì…˜ ë°°í¬ ì „ëµ

### ë¡œë“œ ë°¸ëŸ°ì„œ í—¬ìŠ¤ì²´í¬ ì—°ë™

#### 1. ALB Target Group ì„¤ì •
```json
{
  "HealthCheckPath": "/health",
  "HealthCheckProtocol": "HTTP",
  "HealthCheckPort": "traffic-port",
  "HealthyThresholdCount": 2,
  "UnhealthyThresholdCount": 3,
  "HealthCheckTimeoutSeconds": 5,
  "HealthCheckIntervalSeconds": 30,
  "Matcher": {
    "HttpCode": "200"
  }
}
```

#### 2. ë°°í¬ ê³¼ì •ì—ì„œì˜ Graceful Shutdown
```
1. ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹œì‘
   â””â”€â”€ í—¬ìŠ¤ì²´í¬ í†µê³¼ê¹Œì§€ ëŒ€ê¸°

2. ë¡œë“œ ë°¸ëŸ°ì„œì— ìƒˆ íƒ€ê²Ÿ ë“±ë¡
   â””â”€â”€ ìƒˆ íƒ€ê²Ÿì´ healthy ìƒíƒœ í™•ì¸

3. ê¸°ì¡´ ì»¨í…Œì´ë„ˆì— SIGTERM ì „ì†¡
   â””â”€â”€ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ ì‘ë‹µ ì‹œì‘
   â””â”€â”€ ë¡œë“œ ë°¸ëŸ°ì„œê°€ íŠ¸ë˜í”½ ì¤‘ë‹¨
   â””â”€â”€ ê¸°ì¡´ ìš”ì²­ ì²˜ë¦¬ ì™„ë£Œ
   â””â”€â”€ ì»¨í…Œì´ë„ˆ ì •ìƒ ì¢…ë£Œ

4. ê¸°ì¡´ íƒ€ê²Ÿ ë“±ë¡ í•´ì œ
```

### ECS ë°°í¬ ì„¤ì •
```json
{
  "family": "my-app",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "256",
  "memory": "512",
  "containerDefinitions": [
    {
      "name": "app",
      "image": "my-app:latest",
      "portMappings": [
        {
          "containerPort": 3000
        }
      ],
      "healthCheck": {
        "command": [
          "CMD-SHELL",
          "curl -f http://localhost:3000/health || exit 1"
        ],
        "interval": 30,
        "timeout": 5,
        "retries": 3,
        "startPeriod": 60
      },
      "stopTimeout": 30,
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/my-app",
          "awslogs-region": "ap-northeast-2",
          "awslogs-stream-prefix": "ecs"
        }
      }
    }
  ]
}
```

### Kubernetes ë°°í¬
```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
      - name: app
        image: my-app:latest
        ports:
        - containerPort: 3000
        # Graceful Shutdown ì„¤ì •
        lifecycle:
          preStop:
            exec:
              command:
              - /bin/sh
              - -c
              - sleep 5  # ë¡œë“œë°¸ëŸ°ì„œê°€ ì—”ë“œí¬ì¸íŠ¸ ì œê±°í•  ì‹œê°„
        # í—¬ìŠ¤ì²´í¬
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
        # ë¦¬ì†ŒìŠ¤ ì œí•œ
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        # ì¢…ë£Œ grace period
        terminationGracePeriodSeconds: 30
```

---

## ğŸ“Š Part 6: ëª¨ë‹ˆí„°ë§ê³¼ í…ŒìŠ¤íŠ¸

### ë¡œê¹… ì „ëµ
```javascript
// structured-logging.js
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.Console(),
    new winston.transports.File({ filename: 'app.log' })
  ]
});

// Graceful Shutdownì—ì„œ ì‚¬ìš©
const gracefulShutdown = (signal) => {
  logger.info('Graceful shutdown initiated', { 
    signal,
    timestamp: new Date().toISOString(),
    pid: process.pid
  });
  
  server.close((err) => {
    if (err) {
      logger.error('Error during server close', { 
        error: err.message,
        stack: err.stack 
      });
      process.exit(1);
    }
    
    logger.info('Server closed successfully');
    process.exit(0);
  });
};
```

### ë©”íŠ¸ë¦­ ìˆ˜ì§‘
```javascript
// metrics.js
const promClient = require('prom-client');

// ë©”íŠ¸ë¦­ ì •ì˜
const httpRequestDuration = new promClient.Histogram({
  name: 'http_request_duration_ms',
  help: 'Duration of HTTP requests in ms',
  labelNames: ['method', 'route', 'status_code'],
  buckets: [1, 5, 15, 50, 100, 500]
});

const activeConnections = new promClient.Gauge({
  name: 'active_connections',
  help: 'Number of active connections'
});

// Graceful Shutdown ë©”íŠ¸ë¦­
const shutdownDuration = new promClient.Histogram({
  name: 'shutdown_duration_seconds',
  help: 'Time taken for graceful shutdown',
  buckets: [1, 5, 10, 30, 60]
});

// Express ë¯¸ë“¤ì›¨ì–´
app.use((req, res, next) => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - start;
    httpRequestDuration
      .labels(req.method, req.route?.path || req.path, res.statusCode)
      .observe(duration);
  });
  
  next();
});

// ì„œë²„ ì—°ê²° ì¶”ì 
server.on('connection', (socket) => {
  activeConnections.inc();
  socket.on('close', () => {
    activeConnections.dec();
  });
});

// Graceful Shutdownì—ì„œ ë©”íŠ¸ë¦­ ê¸°ë¡
const gracefulShutdown = (signal) => {
  const shutdownTimer = shutdownDuration.startTimer();
  
  logger.info('Starting graceful shutdown', { signal });
  
  server.close((err) => {
    shutdownTimer();
    
    if (err) {
      logger.error('Shutdown error', { error: err.message });
      process.exit(1);
    }
    
    logger.info('Graceful shutdown completed');
    process.exit(0);
  });
};
```

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
```javascript
// test/graceful-shutdown.test.js
const request = require('supertest');
const { spawn } = require('child_process');

describe('Graceful Shutdown', () => {
  let serverProcess;
  let baseURL;
  
  beforeEach(() => {
    return new Promise((resolve) => {
      serverProcess = spawn('node', ['server.js'], {
        env: { ...process.env, PORT: '0' }
      });
      
      serverProcess.stdout.on('data', (data) => {
        const output = data.toString();
        const match = output.match(/Server running on port (\d+)/);
        if (match) {
          baseURL = `http://localhost:${match[1]}`;
          resolve();
        }
      });
    });
  });
  
  afterEach(() => {
    if (serverProcess) {
      serverProcess.kill('SIGKILL');
    }
  });
  
  test('should handle SIGTERM gracefully', async () => {
    // ì„œë²„ê°€ ì •ìƒ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸
    const response = await request(baseURL).get('/health');
    expect(response.status).toBe(200);
    
    // SIGTERM ì „ì†¡
    serverProcess.kill('SIGTERM');
    
    // ì ì‹œ í›„ ì„œë²„ê°€ ì¢…ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
    await new Promise(resolve => setTimeout(resolve, 3000));
    
    try {
      await request(baseURL).get('/health');
      fail('Server should be closed');
    } catch (err) {
      expect(err.code).toBe('ECONNREFUSED');
    }
  });
  
  test('should complete ongoing requests during shutdown', async () => {
    // ê¸´ ìš”ì²­ ì‹œì‘
    const longRequestPromise = request(baseURL)
      .get('/slow-endpoint')
      .timeout(10000);
    
    // ì ì‹œ í›„ SIGTERM ì „ì†¡
    setTimeout(() => {
      serverProcess.kill('SIGTERM');
    }, 100);
    
    // ê¸´ ìš”ì²­ì´ ì™„ë£Œë˜ì–´ì•¼ í•¨
    const response = await longRequestPromise;
    expect(response.status).toBe(200);
  });
});
```

---

## ğŸ¯ Part 7: ê³ ê¸‰ íŒ¨í„´ê³¼ ìµœì í™”

### Circuit Breakerì™€ í•¨ê»˜ ì‚¬ìš©
```javascript
// circuit-breaker-shutdown.js
const CircuitBreaker = require('opossum');

// ì™¸ë¶€ ì„œë¹„ìŠ¤ í˜¸ì¶œìš© Circuit Breaker
const options = {
  timeout: 3000,
  errorThresholdPercentage: 50,
  resetTimeout: 30000
};

const breaker = new CircuitBreaker(callExternalService, options);

// Graceful Shutdown ì‹œ Circuit Breakerë„ ì •ë¦¬
const gracefulShutdown = async (signal) => {
  console.log(`Received ${signal}, starting graceful shutdown...`);
  
  // 1. ìƒˆë¡œìš´ ìš”ì²­ ì°¨ë‹¨
  isShuttingDown = true;
  
  // 2. Circuit Breaker ë¹„í™œì„±í™”
  breaker.disable();
  
  // 3. ì§„í–‰ ì¤‘ì¸ ìš”ì²­ ì™„ë£Œ ëŒ€ê¸°
  server.close(async (err) => {
    if (err) {
      console.error('Error during server close:', err);
      process.exit(1);
    }
    
    // 4. Circuit Breaker í†µê³„ ì €ì¥ (ì„ íƒì‚¬í•­)
    console.log('Circuit Breaker Stats:', breaker.stats);
    
    process.exit(0);
  });
};
```

### Worker Poolê³¼ í•¨ê»˜ ì‚¬ìš©
```javascript
// worker-pool-shutdown.js
const { Worker, isMainThread, parentPort, workerData } = require('worker_threads');

if (isMainThread) {
  // ë©”ì¸ ìŠ¤ë ˆë“œ
  const workers = [];
  const maxWorkers = 4;
  
  // ì›Œì»¤ ìƒì„±
  for (let i = 0; i < maxWorkers; i++) {
    const worker = new Worker(__filename, {
      workerData: { workerId: i }
    });
    workers.push(worker);
  }
  
  // Graceful Shutdown
  const gracefulShutdown = async (signal) => {
    console.log(`Received ${signal}, shutting down workers...`);
    
    // ëª¨ë“  ì›Œì»¤ì—ê²Œ ì¢…ë£Œ ì‹ í˜¸ ì „ì†¡
    const shutdownPromises = workers.map(worker => {
      return new Promise((resolve) => {
        worker.postMessage({ type: 'shutdown' });
        worker.on('exit', resolve);
      });
    });
    
    // ëª¨ë“  ì›Œì»¤ ì¢…ë£Œ ëŒ€ê¸°
    await Promise.all(shutdownPromises);
    console.log('All workers shut down');
    
    // ë©”ì¸ ì„œë²„ ì¢…ë£Œ
    server.close(() => {
      process.exit(0);
    });
  };
  
  process.on('SIGTERM', gracefulShutdown);
  process.on('SIGINT', gracefulShutdown);
  
} else {
  // ì›Œì»¤ ìŠ¤ë ˆë“œ
  let isWorkerShuttingDown = false;
  
  parentPort.on('message', (msg) => {
    if (msg.type === 'shutdown') {
      isWorkerShuttingDown = true;
      
      // ì§„í–‰ ì¤‘ì¸ ì‘ì—… ì™„ë£Œ í›„ ì¢…ë£Œ
      finishCurrentWork().then(() => {
        process.exit(0);
      });
    }
  });
  
  async function finishCurrentWork() {
    // í˜„ì¬ ì‘ì—… ì™„ë£Œ
    console.log(`Worker ${workerData.workerId} finishing current work...`);
    // ì‹¤ì œ ì •ë¦¬ ì‘ì—…
  }
}
```

### Redis Pub/Subê³¼ í•¨ê»˜ ì‚¬ìš©
```javascript
// redis-pubsub-shutdown.js
const redis = require('redis');

const publisher = redis.createClient();
const subscriber = redis.createClient();

subscriber.subscribe('notifications');

subscriber.on('message', (channel, message) => {
  console.log(`Received message: ${message}`);
});

const gracefulShutdown = async (signal) => {
  console.log(`Received ${signal}, starting graceful shutdown...`);
  
  // 1. Subscriber ì •ë¦¬
  subscriber.unsubscribe();
  await new Promise(resolve => {
    subscriber.quit(resolve);
  });
  
  // 2. Publisher ì •ë¦¬
  await new Promise(resolve => {
    publisher.quit(resolve);
  });
  
  // 3. HTTP ì„œë²„ ì •ë¦¬
  server.close(() => {
    console.log('Graceful shutdown completed');
    process.exit(0);
  });
};

process.on('SIGTERM', gracefulShutdown);
process.on('SIGINT', gracefulShutdown);
```

---

## ğŸ¬ ê²°ë¡ ê³¼ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### í•µì‹¬ ì›ì¹™

#### 1. ì‹ í˜¸ ì²˜ë¦¬ì˜ ì›ì¹™
```javascript
// âœ… ì¢‹ì€ ì˜ˆ
process.on('SIGTERM', gracefulShutdown);
process.on('SIGINT', gracefulShutdown);

// âŒ ë‚˜ìœ ì˜ˆ (ë¬´ì‹œ)
process.on('SIGTERM', () => {});
```

#### 2. íƒ€ì„ì•„ì›ƒ ì„¤ì •
```javascript
// âœ… ì ì ˆí•œ íƒ€ì„ì•„ì›ƒ ì„¤ì •
const SHUTDOWN_TIMEOUT = 30000; // 30ì´ˆ

setTimeout(() => {
  console.error('Graceful shutdown timeout, forcing exit');
  process.exit(1);
}, SHUTDOWN_TIMEOUT);
```

#### 3. ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ìˆœì„œ
```javascript
const gracefulShutdown = async (signal) => {
  // 1. ìƒˆë¡œìš´ ìš”ì²­ ì°¨ë‹¨
  isShuttingDown = true;
  
  // 2. í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ ì‘ë‹µ
  // 3. HTTP ì„œë²„ ì¢…ë£Œ (ìƒˆ ì—°ê²° ì°¨ë‹¨)
  // 4. ì§„í–‰ ì¤‘ì¸ ìš”ì²­ ì™„ë£Œ ëŒ€ê¸°
  // 5. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë¦¬
  // 6. ê¸°íƒ€ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
  // 7. í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
};
```

### ì²´í¬ë¦¬ìŠ¤íŠ¸

#### Docker í™˜ê²½
- [ ] npm ëŒ€ì‹  ì§ì ‘ node ì‹¤í–‰
- [ ] ì ì ˆí•œ STOP_TIMEOUT ì„¤ì •
- [ ] í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
- [ ] ë¡œê·¸ êµ¬ì¡°í™”

#### ì• í”Œë¦¬ì¼€ì´ì…˜
- [ ] SIGTERM/SIGINT í•¸ë“¤ëŸ¬ êµ¬í˜„
- [ ] ì„œë²„ í´ë¡œì¦ˆ ë¡œì§ êµ¬í˜„
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë¦¬
- [ ] íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬

#### ì¸í”„ë¼
- [ ] ë¡œë“œ ë°¸ëŸ°ì„œ í—¬ìŠ¤ì²´í¬ ì—°ë™
- [ ] ë°°í¬ ì „ëµ (ë¡¤ë§ ì—…ë°ì´íŠ¸)
- [ ] ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼
- [ ] í…ŒìŠ¤íŠ¸ ìë™í™”

### ì„±ëŠ¥ ìµœì í™” íŒ

#### 1. ë¹ ë¥¸ ì¢…ë£Œë¥¼ ìœ„í•œ ìµœì í™”
```javascript
// Keep-Alive ì—°ê²° ê´€ë¦¬
const server = app.listen(port);

// ê¸°ë³¸ Keep-Alive íƒ€ì„ì•„ì›ƒ ë‹¨ì¶•
server.keepAliveTimeout = 5000;  // 5ì´ˆ
server.headersTimeout = 6000;    // 6ì´ˆ

// ì—°ê²° ì¶”ì 
const connections = new Set();

server.on('connection', (conn) => {
  connections.add(conn);
  conn.on('close', () => {
    connections.delete(conn);
  });
});

const gracefulShutdown = (signal) => {
  // í™œì„± ì—°ê²° ê°•ì œ ì¢…ë£Œ (í•„ìš”ì‹œ)
  for (const conn of connections) {
    conn.destroy();
  }
  
  server.close(() => {
    process.exit(0);
  });
};
```

#### 2. ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€
```javascript
// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
const gracefulShutdown = (signal) => {
  // ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
  process.removeAllListeners('SIGTERM');
  process.removeAllListeners('SIGINT');
  process.removeAllListeners('uncaughtException');
  process.removeAllListeners('unhandledRejection');
  
  // ì„œë²„ ì¢…ë£Œ
  server.close(() => {
    process.exit(0);
  });
};
```

### ë§ˆì§€ë§‰ ê¶Œì¥ì‚¬í•­

1. **ì‘ê²Œ ì‹œì‘í•˜ê¸°**: ê¸°ë³¸ì ì¸ SIGTERM ì²˜ë¦¬ë¶€í„° ì‹œì‘
2. **ì ì§„ì  ê°œì„ **: í—¬ìŠ¤ì²´í¬ â†’ ë°ì´í„°ë² ì´ìŠ¤ ì •ë¦¬ â†’ ê³ ê¸‰ ê¸°ëŠ¥ ìˆœìœ¼ë¡œ ì¶”ê°€
3. **í…ŒìŠ¤íŠ¸ ì¤‘ìš”ì„±**: ì‹¤ì œ í”„ë¡œë•ì…˜ê³¼ ìœ ì‚¬í•œ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸
4. **ëª¨ë‹ˆí„°ë§ í•„ìˆ˜**: ì¢…ë£Œ ì‹œê°„ê³¼ ì‹¤íŒ¨ìœ¨ ì§€ì†ì  ëª¨ë‹ˆí„°ë§
5. **ë¬¸ì„œí™”**: íŒ€ ì „ì²´ê°€ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ëª…í™•í•œ ë¬¸ì„œ ì‘ì„±

Graceful Shutdownì€ ì•ˆì •ì ì¸ ì„œë¹„ìŠ¤ ìš´ì˜ì˜ ê¸°ë³¸ì´ë‹¤. í•œ ë²ˆ ì œëŒ€ë¡œ êµ¬í˜„í•´ë‘ë©´ ë°°í¬ ì‹œ ì‹ ê²½ ì“¸ ì¼ì´ í˜„ì €íˆ ì¤„ì–´ë“¤ê³ , ì‚¬ìš©ì ê²½í—˜ë„ í¬ê²Œ ê°œì„ ëœë‹¤.