# ğŸ“ TIL (Today I Learned) - JTA (Java Transaction API) êµ¬ì„±

## JTA ê°œìš”
JTAëŠ” Java í™˜ê²½ì—ì„œ ë¶„ì‚° íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•œ APIë¡œ, ì—¬ëŸ¬ ë°ì´í„°ì†ŒìŠ¤ì— ê±¸ì¹œ íŠ¸ëœì­ì…˜ì„ ACID ì†ì„±ì„ ë³´ì¥í•˜ë©´ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

## ì˜ì¡´ì„± ì¶”ê°€

```gradle
// Atomikos JTA êµ¬í˜„ì²´ (Spring Boot 3ìš©)
implementation group: 'com.atomikos', name: 'transactions-spring-boot3-starter', version: '6.0.0'
// Jakarta Transaction API
implementation group: 'jakarta.transaction', name: 'jakarta.transaction-api', version: '2.0.1'
```

## JTA ì„¤ì • êµ¬ì„±

### ì£¼ìš” ì»´í¬ë„ŒíŠ¸

1. **UserTransactionManager**: Atomikosì˜ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €
2. **UserTransaction**: ì‚¬ìš©ì íŠ¸ëœì­ì…˜ ì¸í„°í˜ì´ìŠ¤ 
3. **JtaTransactionManager**: Springì˜ JTA íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €
4. **AtomikosDataSourceBean**: XA ì§€ì› ë°ì´í„°ì†ŒìŠ¤

### ì„¤ì • ì½”ë“œ

```java
@Configuration
@EnableTransactionManagement
public class JtaDataSourceConfig {

    // Atomikos íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ì„¤ì •
    @Bean(initMethod = "init", destroyMethod = "close")
    public UserTransactionManager userTransactionManager() {
        UserTransactionManager userTransactionManager = new UserTransactionManager();
        userTransactionManager.setForceShutdown(false);
        return userTransactionManager;
    }

    // ì‚¬ìš©ì íŠ¸ëœì­ì…˜ ì„¤ì • (íƒ€ì„ì•„ì›ƒ 60ì´ˆ)
    @Bean
    public UserTransaction userTransaction() throws SystemException {
        UserTransactionImp userTransactionImp = new UserTransactionImp();
        userTransactionImp.setTransactionTimeout(60);
        return userTransactionImp;
    }

    // Spring JTA íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €
    @Bean("jtaTransaction")
    public PlatformTransactionManager transactionManager() throws SystemException {
        JtaTransactionManager jtaTransactionManager = new JtaTransactionManager();
        jtaTransactionManager.setUserTransaction(userTransaction());
        jtaTransactionManager.setTransactionManager(userTransactionManager());
        return jtaTransactionManager;
    }

    // ì²« ë²ˆì§¸ XA ë°ì´í„°ì†ŒìŠ¤
    @Bean("jtaGtgearDataSource")
    public DataSource jtaGtgearDataSource() {
        AtomikosDataSourceBean dataSourceBean = new AtomikosDataSourceBean();
        dataSourceBean.setUniqueResourceName("primary-db");
        dataSourceBean.setXaDataSourceClassName("com.mysql.cj.jdbc.MysqlXADataSource");
        
        Properties props = new Properties();
        props.put("url", "jdbc:mysql://...");
        props.put("user", "username");
        props.put("password", "password");
        dataSourceBean.setXaProperties(props);
        
        dataSourceBean.setMaxPoolSize(10);
        dataSourceBean.setMinPoolSize(1);
        return dataSourceBean;
    }

    // ë‘ ë²ˆì§¸ XA ë°ì´í„°ì†ŒìŠ¤
    @Bean("jtaTBNWSDataSource")
    public DataSource jtaTBNWSDataSource() {
        AtomikosDataSourceBean dataSourceBean = new AtomikosDataSourceBean();
        dataSourceBean.setUniqueResourceName("secondary-db");
        dataSourceBean.setXaDataSourceClassName("com.mysql.cj.jdbc.MysqlXADataSource");
        
        Properties props = new Properties();
        props.put("url", "jdbc:mysql://...");
        props.put("user", "username");
        props.put("password", "password");
        dataSourceBean.setXaProperties(props);
        
        dataSourceBean.setMaxPoolSize(10);
        dataSourceBean.setMinPoolSize(1);
        return dataSourceBean;
    }

    // MyBatis SqlSessionFactory ì„¤ì •ë“¤
    @Bean("gtgearSqlSessionFactory")
    public SqlSessionFactory gtgearSqlSessionFactory(@Qualifier("jtaGtgearDataSource") DataSource dataSource) throws Exception {
        SqlSessionFactoryBean factoryBean = new SqlSessionFactoryBean();
        factoryBean.setDataSource(dataSource);
        factoryBean.setMapperLocations(new PathMatchingResourcePatternResolver()
                .getResources("classpath:/mapper/*.xml"));
        return factoryBean.getObject();
    }

    @Bean("tbnwsSqlSessionFactory")
    public SqlSessionFactory tbnwsSqlSessionFactory(@Qualifier("jtaTBNWSDataSource") DataSource dataSource) throws Exception {
        SqlSessionFactoryBean factoryBean = new SqlSessionFactoryBean();
        factoryBean.setDataSource(dataSource);
        factoryBean.setMapperLocations(new PathMatchingResourcePatternResolver()
                .getResources("classpath:/mapper/*.xml"));
        return factoryBean.getObject();
    }

    @Bean("gtgearSqlSessionTemplate")
    public SqlSessionTemplate primarySqlSessionTemplate(@Qualifier("gtgearSqlSessionFactory") SqlSessionFactory sqlSessionFactory) {
        return new SqlSessionTemplate(sqlSessionFactory);
    }

    @Bean("tbnwsSqlSessionTemplate")
    public SqlSessionTemplate secondarySqlSessionTemplate(@Qualifier("tbnwsSqlSessionFactory") SqlSessionFactory sqlSessionFactory) {
        return new SqlSessionTemplate(sqlSessionFactory);
    }
}
```

## ì‚¬ìš©ë²•

JTA íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¶„ì‚° íŠ¸ëœì­ì…˜ ì²˜ë¦¬:

```java
@Transactional(transactionManager = "jtaTransaction")
public Integer someMethod(SomeParameter parameter) {
    // ì—¬ëŸ¬ ë°ì´í„°ì†ŒìŠ¤ì— ê±¸ì¹œ ì‘ì—…ë“¤ì´ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬ë¨
    // ì–´ëŠ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ëª¨ë“  ì‘ì—…ì´ ë¡¤ë°±ë¨
}
```

## ë¶„ì‚° íŠ¸ëœì­ì…˜ ì´ë¡ 

### ACID ì†ì„±
- **Atomicity(ì›ìì„±)**: íŠ¸ëœì­ì…˜ì€ ëª¨ë‘ ì„±ê³µí•˜ê±°ë‚˜ ëª¨ë‘ ì‹¤íŒ¨í•´ì•¼ í•¨
- **Consistency(ì¼ê´€ì„±)**: íŠ¸ëœì­ì…˜ ì „í›„ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœê°€ ì¼ê´€ì„±ì„ ìœ ì§€
- **Isolation(ê³ ë¦½ì„±)**: ë™ì‹œ ì‹¤í–‰ë˜ëŠ” íŠ¸ëœì­ì…˜ë“¤ì´ ì„œë¡œ ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŒ
- **Durability(ì§€ì†ì„±)**: ì»¤ë°‹ëœ íŠ¸ëœì­ì…˜ì˜ ê²°ê³¼ëŠ” ì˜êµ¬ì ìœ¼ë¡œ ì €ì¥

### XA Protocol (eXtended Architecture)
ë¶„ì‚° í™˜ê²½ì—ì„œ ì—¬ëŸ¬ ë¦¬ì†ŒìŠ¤ ë§¤ë‹ˆì € ê°„ì˜ íŠ¸ëœì­ì…˜ì„ ì¡°ì •í•˜ëŠ” í‘œì¤€ í”„ë¡œí† ì½œ

#### 2PC (Two-Phase Commit) ê³¼ì •
1. **Phase 1 - Prepare**:
   - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ê°€ ëª¨ë“  ë¦¬ì†ŒìŠ¤ ë§¤ë‹ˆì €ì—ê²Œ prepare ìš”ì²­
   - ê° ë¦¬ì†ŒìŠ¤ ë§¤ë‹ˆì €ëŠ” ì»¤ë°‹ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ ì‘ë‹µ (YES/NO)
   - ëª¨ë“  ì‘ë‹µì´ YESì—¬ì•¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰

2. **Phase 2 - Commit/Abort**:
   - ëª¨ë“  prepareê°€ ì„±ê³µí•˜ë©´ commit ëª…ë ¹ ì „ì†¡
   - í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ abort ëª…ë ¹ ì „ì†¡
   - ê° ë¦¬ì†ŒìŠ¤ ë§¤ë‹ˆì €ëŠ” ìµœì¢… ì‘ì—… ìˆ˜í–‰

#### XAì˜ ì¥ë‹¨ì 
**ì¥ì **:
- ê°•ë ¥í•œ ë°ì´í„° ì¼ê´€ì„± ë³´ì¥
- í‘œì¤€í™”ëœ í”„ë¡œí† ì½œë¡œ í˜¸í™˜ì„± ìš°ìˆ˜
- ë³µì¡í•œ ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ì•ˆì •ì„± ì œê³µ

**ë‹¨ì **:
- ì„±ëŠ¥ ì˜¤ë²„í—¤ë“œ (ë„¤íŠ¸ì›Œí¬ ë¼ìš´ë“œíŠ¸ë¦½ ì¦ê°€)
- ë¸”ë¡œí‚¹ í”„ë¡œí† ì½œë¡œ ì¸í•œ ê°€ìš©ì„± ì´ìŠˆ
- ë³µì¡í•œ êµ¬í˜„ê³¼ ë””ë²„ê¹…

### JTA ì•„í‚¤í…ì²˜

#### í•µì‹¬ ì»´í¬ë„ŒíŠ¸
1. **Transaction Manager (TM)**:
   - ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜ì˜ ìƒëª…ì£¼ê¸° ê´€ë¦¬
   - 2PC í”„ë¡œí† ì½œ ì¡°ì •
   - ë¦¬ì†ŒìŠ¤ ë§¤ë‹ˆì €ë“¤ê³¼ì˜ í†µì‹ 

2. **Resource Manager (RM)**:
   - ì‹¤ì œ ë¦¬ì†ŒìŠ¤(DB, MQ ë“±)ì— ëŒ€í•œ ì ‘ê·¼ ì œê³µ
   - XA ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
   - ë¡œì»¬ íŠ¸ëœì­ì…˜ ê´€ë¦¬

3. **Application**:
   - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜í–‰
   - Transaction Demarcation ìˆ˜í–‰

#### JTA vs Local Transaction

| êµ¬ë¶„ | Local Transaction | JTA (Distributed Transaction) |
|------|------------------|--------------------------------|
| ë²”ìœ„ | ë‹¨ì¼ ë¦¬ì†ŒìŠ¤ | ì—¬ëŸ¬ ë¦¬ì†ŒìŠ¤ |
| ì„±ëŠ¥ | ë¹ ë¦„ | ìƒëŒ€ì ìœ¼ë¡œ ëŠë¦¼ |
| ì¼ê´€ì„± | ë‹¨ì¼ DB ë‚´ì—ì„œë§Œ | ì—¬ëŸ¬ DB ê°„ ë³´ì¥ |
| ë³µì¡ë„ | ë‹¨ìˆœ | ë³µì¡ |
| ì¥ì•  ë³µêµ¬ | ë‹¨ìˆœ | ë³µì¡ (2PC ë³µêµ¬ ë¡œì§) |

## Atomikos ìƒì„¸ ì„¤ì •

### íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ì„¤ì • ì˜µì…˜

```java
@Bean(initMethod = "init", destroyMethod = "close")
public UserTransactionManager userTransactionManager() {
    UserTransactionManager utm = new UserTransactionManager();
    
    // ê°•ì œ ì¢…ë£Œ ë°©ì§€ (ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì‹œ ì§„í–‰ ì¤‘ì¸ íŠ¸ëœì­ì…˜ ëŒ€ê¸°)
    utm.setForceShutdown(false);
    
    // íŠ¸ëœì­ì…˜ ë¡œê·¸ ë””ë ‰í† ë¦¬ ì„¤ì •
    utm.setTransactionLogDir("./atomikos-logs");
    
    // ì²´í¬í¬ì¸íŠ¸ ê°„ê²© (ms)
    utm.setCheckpointInterval(500);
    
    return utm;
}
```

### íŠ¸ëœì­ì…˜ íƒ€ì„ì•„ì›ƒ ì„¤ì •

```java
@Bean
public UserTransaction userTransaction() throws SystemException {
    UserTransactionImp uti = new UserTransactionImp();
    
    // ê¸°ë³¸ íƒ€ì„ì•„ì›ƒ 60ì´ˆ
    uti.setTransactionTimeout(60);
    
    return uti;
}
```

### XA DataSource ê³ ê¸‰ ì„¤ì •

```java
@Bean("primaryXADataSource")
public DataSource primaryXADataSource() {
    AtomikosDataSourceBean dsBean = new AtomikosDataSourceBean();
    
    // í•„ìˆ˜ ì„¤ì •
    dsBean.setUniqueResourceName("primary-db");
    dsBean.setXaDataSourceClassName("com.mysql.cj.jdbc.MysqlXADataSource");
    
    // ì»¤ë„¥ì…˜ í’€ ì„¤ì •
    dsBean.setMinPoolSize(5);           // ìµœì†Œ ì»¤ë„¥ì…˜ ìˆ˜
    dsBean.setMaxPoolSize(20);          // ìµœëŒ€ ì»¤ë„¥ì…˜ ìˆ˜
    dsBean.setMaxIdleTime(300);         // ìµœëŒ€ ìœ íœ´ ì‹œê°„ (ì´ˆ)
    dsBean.setBorrowConnectionTimeout(30); // ì»¤ë„¥ì…˜ ëŒ€ê¸° ì‹œê°„ (ì´ˆ)
    
    // XA ë³µêµ¬ ì„¤ì •
    dsBean.setMaintenanceInterval(60);   // ìœ ì§€ë³´ìˆ˜ ê°„ê²© (ì´ˆ)
    dsBean.setMaxLifetime(0);           // ì»¤ë„¥ì…˜ ìµœëŒ€ ìƒì¡´ ì‹œê°„ (0=ë¬´ì œí•œ)
    
    // í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬
    dsBean.setTestQuery("SELECT 1");
    
    Properties props = new Properties();
    props.put("url", "jdbc:mysql://localhost:3306/db1");
    props.put("user", "username");
    props.put("password", "password");
    props.put("pinGlobalTxToPhysicalConnection", "true"); // XA ìµœì í™”
    dsBean.setXaProperties(props);
    
    return dsBean;
}
```

## íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€

### Spring @Transactional ì†ì„±

```java
@Transactional(
    transactionManager = "jtaTransaction",
    isolation = Isolation.READ_COMMITTED,    // ê²©ë¦¬ ìˆ˜ì¤€
    propagation = Propagation.REQUIRED,      // ì „íŒŒ ì†ì„±
    timeout = 30,                            // íƒ€ì„ì•„ì›ƒ (ì´ˆ)
    rollbackFor = Exception.class,           // ë¡¤ë°± ì˜ˆì™¸
    noRollbackFor = IllegalArgumentException.class // ë¡¤ë°± ì œì™¸ ì˜ˆì™¸
)
public void businessMethod() {
    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
}
```

### ê²©ë¦¬ ìˆ˜ì¤€ ì¢…ë¥˜
1. **READ_UNCOMMITTED**: Dirty Read ë°œìƒ ê°€ëŠ¥
2. **READ_COMMITTED**: Dirty Read ë°©ì§€, Non-repeatable Read ë°œìƒ ê°€ëŠ¥
3. **REPEATABLE_READ**: Non-repeatable Read ë°©ì§€, Phantom Read ë°œìƒ ê°€ëŠ¥
4. **SERIALIZABLE**: ëª¨ë“  ë™ì‹œì„± ë¬¸ì œ ë°©ì§€, ì„±ëŠ¥ ì €í•˜

### ì „íŒŒ ì†ì„± (Propagation)
- **REQUIRED**: ê¸°ì¡´ íŠ¸ëœì­ì…˜ ì°¸ì—¬, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
- **REQUIRES_NEW**: í•­ìƒ ìƒˆ íŠ¸ëœì­ì…˜ ìƒì„±
- **SUPPORTS**: ê¸°ì¡´ íŠ¸ëœì­ì…˜ ì°¸ì—¬, ì—†ì–´ë„ ë¨
- **MANDATORY**: ê¸°ì¡´ íŠ¸ëœì­ì…˜ í•„ìˆ˜, ì—†ìœ¼ë©´ ì˜ˆì™¸
- **NOT_SUPPORTED**: íŠ¸ëœì­ì…˜ ì—†ì´ ì‹¤í–‰
- **NEVER**: íŠ¸ëœì­ì…˜ ìˆìœ¼ë©´ ì˜ˆì™¸
- **NESTED**: ì¤‘ì²© íŠ¸ëœì­ì…˜ ì‚¬ìš©

## ëª¨ë‹ˆí„°ë§ ë° ë””ë²„ê¹…

### ë¡œê·¸ ì„¤ì •

```properties
# Atomikos ë¡œê·¸ ë ˆë²¨
logging.level.com.atomikos=DEBUG

# JTA íŠ¸ëœì­ì…˜ ë¡œê·¸
logging.level.org.springframework.transaction=DEBUG

# SQL ì‹¤í–‰ ë¡œê·¸
logging.level.org.mybatis=DEBUG
```

### íŠ¸ëœì­ì…˜ ìƒíƒœ í™•ì¸

```java
@Autowired
private PlatformTransactionManager transactionManager;

public void checkTransactionStatus() {
    TransactionStatus status = transactionManager.getTransaction(
        new DefaultTransactionDefinition()
    );
    
    System.out.println("Is new transaction: " + status.isNewTransaction());
    System.out.println("Has savepoint: " + status.hasSavepoint());
    System.out.println("Is rollback only: " + status.isRollbackOnly());
    System.out.println("Is completed: " + status.isCompleted());
}
```

## ì„±ëŠ¥ ìµœì í™” ë° ì£¼ì˜ì‚¬í•­

### ì„±ëŠ¥ ìµœì í™”
1. **ì»¤ë„¥ì…˜ í’€ íŠœë‹**: ì ì ˆí•œ min/max ì»¤ë„¥ì…˜ ìˆ˜ ì„¤ì •
2. **íƒ€ì„ì•„ì›ƒ ìµœì í™”**: ë¶ˆí•„ìš”í•˜ê²Œ ê¸´ íƒ€ì„ì•„ì›ƒ ë°©ì§€
3. **ë°°ì¹˜ ì²˜ë¦¬**: ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì‹œ ì²­í¬ ë‹¨ìœ„ë¡œ ë¶„í• 
4. **ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜**: `@Transactional(readOnly = true)` í™œìš©

### ì£¼ì˜ì‚¬í•­
1. **ë°ë“œë½ ë°©ì§€**: ë¦¬ì†ŒìŠ¤ ì ‘ê·¼ ìˆœì„œ ì¼ê´€ì„± ìœ ì§€
2. **íŠ¸ëœì­ì…˜ ë²”ìœ„ ìµœì†Œí™”**: í•„ìš”í•œ ë²”ìœ„ë§Œ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ê¸°
3. **ì¥ì‹œê°„ íŠ¸ëœì­ì…˜ ë°©ì§€**: ì‚¬ìš©ì ì…ë ¥ ëŒ€ê¸° ë“±ì€ íŠ¸ëœì­ì…˜ ì™¸ë¶€ì—ì„œ
4. **ì˜ˆì™¸ ì²˜ë¦¬**: ì ì ˆí•œ rollback ì¡°ê±´ ì„¤ì •

### ëŒ€ì•ˆ íŒ¨í„´
- **Saga Pattern**: ì¥ê¸° ì‹¤í–‰ í”„ë¡œì„¸ìŠ¤ì— ì í•©
- **Event Sourcing**: ì´ë²¤íŠ¸ ê¸°ë°˜ ì¼ê´€ì„± ê´€ë¦¬
- **CQRS**: ì½ê¸°/ì“°ê¸° ë¶„ë¦¬ë¡œ ì„±ëŠ¥ í–¥ìƒ
