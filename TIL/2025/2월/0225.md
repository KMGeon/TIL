# ğŸ“ TIL (Today I Learned)

--- 

### 1. íŒë§¤ëŸ‰ ì˜ˆì¸¡ poc - ë¨¸ì‹ ëŸ¬ë‹

- ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” LGBM ëª¨ë¸ë¡œ ì˜ˆì¸¡ì„ ë§Œë“¤ì–´ ë³´ê³  íšŒì‚¬ì—ì„œ ì ìš©í•  ìˆ˜ ìˆëŠ”ì§€ ìƒê°í•´ë³´ê¸°


```py
import numpy as np
import pandas as pd
import warnings
import seaborn as sns
import matplotlib as mpl
import matplotlib.pyplot as plt
%matplotlib inline
from itertools import product
import lightgbm as lgb

warnings.filterwarnings(action='ignore')

# date,item_code,item_cnt
data_path = '../data/'
train = pd.read_csv(data_path + 'sample_data.csv')

train = train.rename(
    columns={
        'date': 'ë‚ ì§œ',
        'item_code': 'ìƒí’ˆë²ˆí˜¸',
        'item_cnt': 'ìˆ˜ëŸ‰',
        'date_block_num': 'ì›”id'
    }
)

# ê·¸ë£¹í™”í•  ë•Œ 'ì›”id'ë„ í¬í•¨
group_train_data = train.groupby(['ë‚ ì§œ', 'ìƒí’ˆë²ˆí˜¸', 'ì›”id'], as_index=False).agg(
    ì¼ë³„ìƒí’ˆìˆ˜ëŸ‰=('ìˆ˜ëŸ‰', 'sum')
)

def downcast(df, verbose=True):
    start_mem = df.memory_usage().sum() / 1024 ** 2
    for col in df.columns:
        dtype_name = df[col].dtype.name
        if dtype_name == 'object':
            pass
        elif dtype_name == 'bool':
            df[col] = df[col].astype('int8')
        elif dtype_name.startswith('int') or (df[col].round() == df[col]).all():
            df[col] = pd.to_numeric(df[col], downcast='integer')
        else:
            df[col] = pd.to_numeric(df[col], downcast='float')
    end_mem = df.memory_usage().sum() / 1024 ** 2
    if verbose:
        print(f'{100 * (start_mem - end_mem) / start_mem : .1f}% ì••ì¶•ë¨')
    return df

all_df = [train]
for df in all_df:
    df = downcast(train)

# ì›”ë³„, ìƒí’ˆë³„ íŒë§¤ëŸ‰ ì§‘ê³„
idx_features = ['ì›”id', 'ìƒí’ˆë²ˆí˜¸']
group = group_train_data.groupby(idx_features, as_index=False).agg(
    ì›”ê°„íŒë§¤ëŸ‰=('ì¼ë³„ìƒí’ˆìˆ˜ëŸ‰', 'sum')
)

# ë¡œê·¸ ë³€í™˜ ì ìš©
group['ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸'] = np.log1p(group['ì›”ê°„íŒë§¤ëŸ‰'])

# ìƒí’ˆë³„ í‰ê·  íŒë§¤ëŸ‰ ê³„ì‚°
group['í‰ê· íŒë§¤ëŸ‰'] = group.groupby('ìƒí’ˆë²ˆí˜¸')['ì›”ê°„íŒë§¤ëŸ‰'].transform('mean')

# íŒë§¤ëŸ‰ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹ ë¶„ë¥˜
group['ìƒí’ˆê·¸ë£¹'] = pd.cut(group['í‰ê· íŒë§¤ëŸ‰'],
                       bins=[0, 50, float('inf')],
                       labels=['ì¼ë°˜ìƒí’ˆ', 'ì¸ê¸°ìƒí’ˆ'])

print("140~143ì›”ì˜ ìƒí’ˆ ìˆ˜:")
for month in range(140, 144):
    products = group[group['ì›”id'] == month]['ìƒí’ˆë²ˆí˜¸'].nunique()
    print(f"{month}ì›”: {products}ê°œ")

# ê·¸ë£¹ë³„ë¡œ ë°ì´í„° ë¶„ë¦¬
popular_items = group[group['ìƒí’ˆê·¸ë£¹'] == 'ì¸ê¸°ìƒí’ˆ']
normal_items = group[group['ìƒí’ˆê·¸ë£¹'] == 'ì¼ë°˜ìƒí’ˆ']


# ì¸ê¸°ìƒí’ˆì— ëŒ€í•œ IQR (ìƒí•œê°’ì„ ë” ë†’ê²Œ ì„¤ì •)
Q1_popular = popular_items['ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸'].quantile(0.25)
Q3_popular = popular_items['ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸'].quantile(0.75)
IQR_popular = Q3_popular - Q1_popular
lower_bound_popular = Q1_popular - 1.5 * IQR_popular
upper_bound_popular = Q3_popular + 1.5 * IQR_popular

# ì¸ê¸°ìƒí’ˆ ì´ìƒì¹˜ ì²˜ë¦¬
popular_items_clean = popular_items[(popular_items['ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸'] >= lower_bound_popular) &
                                  (popular_items['ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸'] <= upper_bound_popular)].copy()

# ì¼ë°˜ìƒí’ˆì— ëŒ€í•´ì„œë§Œ IQR ì ìš©
Q1 = normal_items['ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸'].quantile(0.25)
Q3 = normal_items['ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸'].quantile(0.75)
IQR = Q3 - Q1
lower_bound = Q1 - 1.5 * IQR
upper_bound = Q3 + 1.5 * IQR

# ì¼ë°˜ìƒí’ˆ ì´ìƒì¹˜ ì²˜ë¦¬
normal_items_clean = normal_items[(normal_items['ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸'] >= lower_bound) &
                                (normal_items['ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸'] <= upper_bound)].copy()

popular_items
sns.boxplot(y='ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸', data=popular_items)

# print("\nì¸ê¸°ìƒí’ˆ ìˆ˜:", len(popular_items['ìƒí’ˆë²ˆí˜¸'].unique()))
# print("ì¼ë°˜ìƒí’ˆ ìˆ˜ (IQR ì²˜ë¦¬ ì „):", len(normal_items['ìƒí’ˆë²ˆí˜¸'].unique()))
# print("ì¼ë°˜ìƒí’ˆ ìˆ˜ (IQR ì²˜ë¦¬ í›„):", len(normal_items_clean['ìƒí’ˆë²ˆí˜¸'].unique()))

# ì¸ê¸°ìƒí’ˆ ëª¨ë¸ìš© ë°ì´í„°
X_train_popular = popular_items.loc[popular_items['ì›”id'] < 10].drop(['ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸', 'í‰ê· íŒë§¤ëŸ‰', 'ìƒí’ˆê·¸ë£¹'], axis=1)
X_valid_popular = popular_items.loc[popular_items['ì›”id'] == 10].drop(['ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸', 'í‰ê· íŒë§¤ëŸ‰', 'ìƒí’ˆê·¸ë£¹'], axis=1)
X_test_popular = popular_items.loc[popular_items['ì›”id'] == 11].drop(['ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸', 'í‰ê· íŒë§¤ëŸ‰', 'ìƒí’ˆê·¸ë£¹'], axis=1)

y_train_popular = popular_items.loc[popular_items['ì›”id'] < 10, 'ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸']
y_valid_popular = popular_items.loc[popular_items['ì›”id'] == 10, 'ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸']

# ì¼ë°˜ìƒí’ˆ ëª¨ë¸ìš© ë°ì´í„° (IQR ì²˜ë¦¬ëœ)
X_train_normal = normal_items_clean.loc[normal_items_clean['ì›”id'] < 10].drop(['ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸', 'í‰ê· íŒë§¤ëŸ‰', 'ìƒí’ˆê·¸ë£¹'], axis=1)
X_valid_normal = normal_items_clean.loc[normal_items_clean['ì›”id'] == 10].drop(['ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸', 'í‰ê· íŒë§¤ëŸ‰', 'ìƒí’ˆê·¸ë£¹'], axis=1)
X_test_normal = normal_items_clean.loc[normal_items_clean['ì›”id'] == 11].drop(['ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸', 'í‰ê· íŒë§¤ëŸ‰', 'ìƒí’ˆê·¸ë£¹'], axis=1)

y_train_normal = normal_items_clean.loc[normal_items_clean['ì›”id'] < 10, 'ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸']
y_valid_normal = normal_items_clean.loc[normal_items_clean['ì›”id'] == 10, 'ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸']

# ëª¨ë¸ íŒŒë¼ë¯¸í„°
params = {
    'metric': 'rmse',

    'num_leaves': 255,
    'learning_rate': 0.01,
    'force_col_wise': True,
    'random_state': 10
}

# ë²”ì£¼í˜• í”¼ì²˜ì„¤ì •
cat_features = ['ìƒí’ˆë²ˆí˜¸']

# ì¸ê¸°ìƒí’ˆ ëª¨ë¸
dtrain_popular = lgb.Dataset(X_train_popular, y_train_popular)
dvalid_popular = lgb.Dataset(X_valid_popular, y_valid_popular)

lgb_model_popular = lgb.train(params=params,
                             train_set=dtrain_popular,
                             num_boost_round=1500,
                             valid_sets=(dtrain_popular, dvalid_popular),
                             categorical_feature=cat_features,
                             callbacks=[lgb.log_evaluation(period=150)])

# ì¼ë°˜ìƒí’ˆ ëª¨ë¸
dtrain_normal = lgb.Dataset(X_train_normal, y_train_normal)
dvalid_normal = lgb.Dataset(X_valid_normal, y_valid_normal)

lgb_model_normal = lgb.train(params=params,
                            train_set=dtrain_normal,
                            num_boost_round=1500,
                            valid_sets=(dtrain_normal, dvalid_normal),
                            categorical_feature=cat_features,
                            callbacks=[lgb.log_evaluation(period=150)])

# ì˜ˆì¸¡
preds_popular = lgb_model_popular.predict(X_test_popular).clip(0, 20)
preds_normal = lgb_model_normal.predict(X_test_normal).clip(0, 20)

# ê²°ê³¼ í†µí•©
results_popular = pd.DataFrame({
    'ì›”id': X_test_popular['ì›”id'],
    'ìƒí’ˆë²ˆí˜¸': X_test_popular['ìƒí’ˆë²ˆí˜¸'],
    'ì˜ˆì¸¡_ì›”ê°„íŒë§¤ëŸ‰': np.expm1(preds_popular),
    'ì˜ˆì¸¡_ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸': preds_popular,
    'ìƒí’ˆê·¸ë£¹': 'ì¸ê¸°ìƒí’ˆ'
})

results_normal = pd.DataFrame({
    'ì›”id': X_test_normal['ì›”id'],
    'ìƒí’ˆë²ˆí˜¸': X_test_normal['ìƒí’ˆë²ˆí˜¸'],
    'ì˜ˆì¸¡_ì›”ê°„íŒë§¤ëŸ‰': np.expm1(preds_normal),
    'ì˜ˆì¸¡_ì›”ê°„íŒë§¤ëŸ‰_ë¡œê·¸': preds_normal,
    'ìƒí’ˆê·¸ë£¹': 'ì¼ë°˜ìƒí’ˆ'
})

results_df = pd.concat([results_popular, results_normal])

# ê²°ê³¼ í™•ì¸
print("\n=== ì˜ˆì¸¡ ê²°ê³¼ ===")
print("\nì¸ê¸°ìƒí’ˆ ì˜ˆì¸¡ í†µê³„:")
print(results_popular['ì˜ˆì¸¡_ì›”ê°„íŒë§¤ëŸ‰'].describe())
print("\nì¼ë°˜ìƒí’ˆ ì˜ˆì¸¡ í†µê³„:")
print(results_normal['ì˜ˆì¸¡_ì›”ê°„íŒë§¤ëŸ‰'].describe())

# CSV íŒŒì¼ë¡œ ì €ì¥
output_path = '../predictions.csv'
results_df.to_csv(output_path, index=False)
print(f"\nì˜ˆì¸¡ ê²°ê³¼ê°€ {output_path}ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

# ì˜ˆì¸¡ê°’ ë¶„í¬ ì‹œê°í™”
plt.figure(figsize=(15, 5))
plt.subplot(1, 3, 1)
sns.histplot(data=results_df, x='ì˜ˆì¸¡_ì›”ê°„íŒë§¤ëŸ‰', hue='ìƒí’ˆê·¸ë£¹', bins=50)
plt.title('Predictions Distribution by Group (Original Scale)')

plt.subplot(1, 3, 2)
sns.histplot(data=results_df[results_df['ìƒí’ˆê·¸ë£¹']=='ì¸ê¸°ìƒí’ˆ'], x='ì˜ˆì¸¡_ì›”ê°„íŒë§¤ëŸ‰', bins=50)
plt.title('Popular Items Predictions')

plt.subplot(1, 3, 3)
sns.histplot(data=results_df[results_df['ìƒí’ˆê·¸ë£¹']=='ì¼ë°˜ìƒí’ˆ'], x='ì˜ˆì¸¡_ì›”ê°„íŒë§¤ëŸ‰', bins=50)
plt.title('Normal Items Predictions')

plt.tight_layout()
plt.show()
```

- ì¼ë‹¨ LGBMì€ ì‹œê³„ì—´ ëª¨ë¸ì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ì‹œê°„ì„ ë‚˜íƒ€ë‚´ëŠ” 1ë‹¬ì„ í”¼ì²˜ë¡œ ë‘ê³  í•™ìŠµì„ í•˜ì˜€ì„ ë•Œ ë°ì´í„°ëŠ” ì–´ëŠì •ë„ ì‹ ë¢°ì„±ì„ ë³¼ ìˆ˜ ìˆë‹¤.
- ê·¸ëŸ°ë° ë°ì´í„°ê°€ ë§ì•„ì§€ë©´ ì˜¤íˆë ¤ ë” ì •í™•í•˜ê²Œ ë˜ëŠ” ì¤„ ì•Œì•˜ëŠ”ë° ì§€ê¸ˆ ì…ˆí”Œ 1ë…„ì¹˜ ë°ì´í„°ë¥¼ ë„£ìœ¼ë©´ ì™„ì „ ì„±ëŠ¥ì´ ë‚˜ì˜¤ì§€ ëª»í•œë‹¤.


